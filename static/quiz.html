<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quiz Room</title>

    <link rel="stylesheet" href="../static/css/base.css">

    <script type="module">
        import * as player from "../static/js/player.js";
        import * as ws from "../static/js/ws.js";

        ws.setCallbacks({
            onAdminNotify: onAdminNotify,
            onEnterNotify: onEnterNotify,
            onSendVideo: onSendVideo,
            onStartPlaying: onStartPlaying,
            onAnswer: onAnswer,
            onGameOver: onGameOver,
        });

        player.init("player", () => {
            document.getElementById("content-loader").style.display = "none";
            document.getElementById("content-join-form").style.display = "block";
        });

        document.getElementById("content-join-form").onsubmit = joinGame;
        document.getElementById("start-button").onclick = startGame;
        document.getElementById("content-quiz-form").onsubmit = sendAnswer;
        document.getElementById("content-header-volume").oninput = function () {
            player.setVolume(parseInt(this.value));
        };

        function joinGame(event) {
            event.preventDefault();

            let user_id = document.getElementById("user-id").value;
            if (user_id === "") {
                return
            }

            // split /quiz/room_id
            let room_id = window.location.pathname.split("/")[2];

            ws.initConnection(user_id, room_id);

            document.getElementById("content-join-form").style.display = "none";
            document.getElementById("content-quiz").style.display = "block";
        }

        function onEnterNotify(data) {
            data = JSON.parse(data);
            document.getElementById("content-header-counter").innerText = "(в игре: " + data["count"] + ")";

            let message = document.createElement("div");
            message.innerText = data["user_id"] + " подключился";

            document.getElementById("messages").appendChild(message);
            setTimeout(() => {
                message.remove();
            }, 30 * 1000);
        }

        function onAdminNotify() {
            document.getElementById("start-button").style.display = "inline";
        }

        function startGame() {
            document.getElementById("start-button").style.display = "none";

            ws.sendUserNotify("startGame");
        }

        function onSendVideo(data) {
            document.getElementById("content-quiz-status").innerText = "Загружаем звук";

            data = JSON.parse(data);

            player.loadVideo(data["video_id"], data["start"], () => {
                ws.sendUserNotify("")
            })
        }

        function onStartPlaying() {
            document.getElementById("content-quiz-status").innerText = "Угадываем";
            document.getElementById("content-quiz-form").style.display = "block";
            document.getElementById("content-quiz-input").focus();

            player.playVideo();
        }

        function sendAnswer(event) {
            event.preventDefault();

            let answer = document.getElementById("content-quiz-input").value;
            if (answer === "") {
                return;
            }
            document.getElementById("content-quiz-input").value = "";

            document.getElementById("content-quiz-form").style.display = "none";

            ws.sendAnswer(answer);
        }

        function onAnswer(answer) {
            document.getElementById("content-quiz-status").innerText = "Правильный ответ: " + answer;
            document.getElementById("content-quiz-form").style.display = "none";
        }

        function onGameOver(data) {
            document.getElementById("content-quiz").style.display = "none";
            player.stopVideo();

            let leaderboard = JSON.parse(data);

            for (let user_id in leaderboard) {
                let li = document.createElement("li");
                li.innerText = user_id + ": " + leaderboard[user_id];

                document.getElementById("content-leaderboard-list").appendChild(li);
            }
        }
    </script>
</head>
<body>

<div class="container">
    <div class="content">
        <div class="content-head">
            Угадай аниме <span id="content-header-counter"></span>
            <input type="range" id="content-header-volume" value="100" min="0" max="100">
        </div>

        <div id="content-loader">Подготавливаем браузер</div>
        <form id="content-join-form" style="display: none">
            <input type="text" id="user-id" placeholder="Никнейм">
            <button class="button">Войти</button>
        </form>


        <div id="content-quiz" style="display: none">
            <div id="content-quiz-status">Ожидаем запуска игры</div>

            <button class="button" id="start-button">Начать игру</button>

            <form id="content-quiz-form" style="display: none">
                <input type="text" maxlength="50" id="content-quiz-input">
                <button class="button">Отправить</button>
            </form>
        </div>

        <div class="content-leaderboard">
            <ul id="content-leaderboard-list"></ul>
        </div>
    </div>
</div>

<div id="messages">

</div>

<div id="player" style="display: none"></div>

</body>
</html>